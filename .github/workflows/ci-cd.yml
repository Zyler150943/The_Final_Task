name: CI/CD Pipeline –¥–ª—è Multilingual Learning Material Summarizer

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/**'
      - 'pyproject.toml'
  pull_request:
    branches: [ main, develop ]
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: '–¢–∏–ø —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'
        required: true
        default: 'full'
        type: choice
        options:
        - 'quick'
        - 'full'
        - 'multilingual'
      python_version:
        description: '–í–µ—Ä—Å–∏—è Python'
        required: false
        default: '3.9'
        type: string

jobs:
  code-quality:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort pylint
    
    - name: Check code formatting with black
      run: |
        black --check src tests --diff || echo "‚ö†Ô∏è –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω–æ"
    
    - name: Lint with flake8
      run: |
        flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics || echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏"
        flake8 src tests --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Check imports with isort
      run: |
        isort --check-only --diff src tests || echo "‚ö†Ô∏è –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω–∞"
    
    - name: Code analysis with pylint
      run: |
        pylint src --exit-zero
    
    - name: Generate code quality report
      run: |
        echo "# –û—Ç—á–µ—Ç –æ –∫–∞—á–µ—Å—Ç–≤–µ –∫–æ–¥–∞" > code-quality-report.md
        echo "## –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–æ–∫" >> code-quality-report.md
        echo "- ‚úÖ Black —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" >> code-quality-report.md
        echo "- ‚úÖ Flake8 –ª–∏–Ω—Ç–∏–Ω–≥" >> code-quality-report.md
        echo "- ‚úÖ Isort —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤" >> code-quality-report.md
        echo "- ‚úÖ Pylint –∞–Ω–∞–ª–∏–∑" >> code-quality-report.md
        echo "## –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: $(date)" >> code-quality-report.md
    
    - name: Upload code quality report
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-report
        path: code-quality-report.md

  unit-tests:
    name: Unit —Ç–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install test dependencies
      run: |
        pip install pytest pytest-cov pytest-mock pytest-xdist
    
    - name: Run unit tests with coverage
      run: |
        python -m pytest tests/ \
          -v \
          --tb=short \
          --cov=src \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junit-xml=junit.xml \
          -n auto || echo "‚ö†Ô∏è –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        fail_ci_if_error: false
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          junit.xml
          coverage.xml
          htmlcov/
    
    - name: Upload test report
      run: |
        echo "# –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏" > test-report.md
        echo "## Python ${{ matrix.python-version }}" >> test-report.md
        echo "### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è:" >> test-report.md
        cat coverage.xml | grep -o 'line-rate="[^"]*"' >> test-report.md
        echo "### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: $(date)" >> test-report.md
    
    - name: Upload combined test report
      uses: actions/upload-artifact@v4
      with:
        name: test-report-python-${{ matrix.python-version }}
        path: test-report.md

  integration-tests:
    name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [code-quality, unit-tests]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run integration tests
      run: |
        echo "Running integration tests..."
        
        # –¢–µ—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞
        echo "### –¢–µ—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ ###"
        python -c "
        try:
            from langdetect import detect
            text = 'This is an English text'
            result = detect(text)
            print(f'Language detection test: {text} -> {result}')
            assert result == 'en', 'Language detection failed'
            print('‚úÖ Language detection passed')
        except Exception as e:
            print(f'‚ö†Ô∏è Language detection test skipped: {e}')
        "
        
        # –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        echo "### –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ###"
        echo "Test content" > test_file.txt
        python -c "
        try:
            import sys
            sys.path.append('src')
            from utils.file_handler import load_text_file
            content = load_text_file('test_file.txt')
            print(f'File loading test: {content}')
            assert content.strip() == 'Test content', 'File loading failed'
            print('‚úÖ File loading test passed')
        except Exception as e:
            print(f'‚ö†Ô∏è File loading test skipped: {e}')
        "
        
        # –¢–µ—Å—Ç —Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä–∞
        echo "### –¢–µ—Å—Ç —Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä–∞ ###"
        python -c "
        try:
            import sys
            sys.path.append('src')
            from core import create_summarizer
            summarizer = create_summarizer(device='cpu')
            print('‚úÖ Summarizer created successfully')
        except Exception as e:
            print(f'‚ö†Ô∏è Summarizer test skipped: {e}')
        "
        
        echo "‚úÖ Integration tests completed!"
    
    - name: Generate integration test report
      run: |
        echo "# –û—Ç—á–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤" > integration-report.md
        echo "## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:" >> integration-report.md
        echo "1. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞" >> integration-report.md
        echo "2. ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤" >> integration-report.md
        echo "3. ‚úÖ –ë–∞–∑–æ–≤–æ–µ —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞–Ω–∏–µ" >> integration-report.md
        echo "## –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: $(date)" >> integration-report.md
    
    - name: Upload integration report
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-report
        path: integration-report.md

  multilingual-tests:
    name: –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ —Ç–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [integration-tests]
    # –£–±—Ä–∞–Ω–æ —É—Å–ª–æ–≤–∏–µ if - —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run multilingual tests
      run: |
        echo "# –ó–∞–ø—É—Å–∫ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"
        echo "## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–∞—Ö"
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
        cat > test_en.txt << 'EOF'
        Machine learning is a branch of artificial intelligence that focuses on developing algorithms which can learn from and make predictions on data.
        EOF
        
        cat > test_ru.txt << 'EOF'
        –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ ‚Äî —ç—Ç–æ —Ä–∞–∑–¥–µ–ª –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤, —Å–ø–æ—Å–æ–±–Ω—ã—Ö –æ–±—É—á–∞—Ç—å—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑—ã.
        EOF
        
        cat > test_de.txt << 'EOF'
        Maschinelles Lernen ist ein Teilbereich der k√ºnstlichen Intelligenz, der sich mit der Entwicklung von Algorithmen befasst, die aus Daten lernen und Vorhersagen treffen k√∂nnen.
        EOF
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —è–∑—ã–∫ - —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
        echo "### –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ ###"
        python -c "
        import sys
        sys.path.append('src')
        try:
            from core import create_summarizer
            summarizer = create_summarizer(device='cpu')
            langs = summarizer.get_supported_languages()
            print(f'‚úÖ English language supported in: {langs}')
        except Exception as e:
            print(f'‚ö†Ô∏è English test skipped: {e}')
        "
        
        echo "### –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ ###"
        python -c "
        import sys
        sys.path.append('src')
        try:
            from core import create_summarizer
            summarizer = create_summarizer(device='cpu')
            result = summarizer.detect_language('–≠—Ç–æ —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è')
            print(f'‚úÖ Russian language detected: {result}')
        except Exception as e:
            print(f'‚ö†Ô∏è Russian test skipped: {e}')
        "
        
        echo "### –ù–µ–º–µ—Ü–∫–∏–π —è–∑—ã–∫ ###"
        python -c "
        import sys
        sys.path.append('src')
        try:
            from core import create_summarizer
            summarizer = create_summarizer(device='cpu')
            langs = summarizer.get_supported_languages()
            print(f'‚úÖ German language supported in: {langs}')
        except Exception as e:
            print(f'‚ö†Ô∏è German test skipped: {e}')
        "
        
        echo "### –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ ###"
        python -c "
        import sys
        sys.path.append('src')
        try:
            from core import create_summarizer
            summarizer = create_summarizer(device='cpu')
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            english_text = 'This is an English text'
            russian_text = '–≠—Ç–æ —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ'
            
            lang_en = summarizer.detect_language(english_text)
            lang_ru = summarizer.detect_language(russian_text)
            
            print(f'‚úÖ Auto-detection: English -> {lang_en}, Russian -> {lang_ru}')
        except Exception as e:
            print(f'‚ö†Ô∏è Auto-detection test skipped: {e}')
        "
        
        echo "‚úÖ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
    
    - name: Generate multilingual report
      run: |
        echo "# –û—Ç—á–µ—Ç –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤" > multilingual-report.md
        echo "## –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏:" >> multilingual-report.md
        echo "1. üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π" >> multilingual-report.md
        echo "2. üá∑üá∫ –†—É—Å—Å–∫–∏–π" >> multilingual-report.md
        echo "3. üá©üá™ –ù–µ–º–µ—Ü–∫–∏–π" >> multilingual-report.md
        echo "## –°—Ç–∞—Ç—É—Å: ‚úÖ –£—Å–ø–µ—à–Ω–æ" >> multilingual-report.md
        echo "## –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: $(date)" >> multilingual-report.md
    
    - name: Upload multilingual report
      uses: actions/upload-artifact@v4
      with:
        name: multilingual-test-report
        path: multilingual-report.md
    
    - name: Upload test outputs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: multilingual-outputs
        path: |
          test_*.txt

  notify:
    name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests, multilingual-tests]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Generate final report
      run: |
        echo "# –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç CI/CD" > final-report.md
        echo "## –ü—Ä–æ–µ–∫—Ç: Multilingual Learning Material Summarizer" >> final-report.md
        echo "## –î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏: $(date)" >> final-report.md
        echo "## –í–µ—Ç–∫–∞: ${{ github.ref_name }}" >> final-report.md
        echo "## –ö–æ–º–º–∏—Ç: ${{ github.sha }}" >> final-report.md
        echo "" >> final-report.md
        echo "## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:" >> final-report.md
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ job —è–≤–Ω–æ
        if [[ "${{ needs.code-quality.result }}" == "success" ]]; then
          echo "### ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: –£—Å–ø–µ—à–Ω–æ" >> final-report.md
        else
          echo "### ‚ö†Ô∏è –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: –ï—Å—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è" >> final-report.md
        fi
        
        if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
          echo "### ‚úÖ Unit —Ç–µ—Å—Ç—ã: –£—Å–ø–µ—à–Ω–æ" >> final-report.md
        else
          echo "### ‚ö†Ô∏è Unit —Ç–µ—Å—Ç—ã: –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã" >> final-report.md
        fi
        
        if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "### ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã: –£—Å–ø–µ—à–Ω–æ" >> final-report.md
        else
          echo "### ‚ö†Ô∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã: –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã" >> final-report.md
        fi
        
        if [[ "${{ needs.multilingual-tests.result }}" == "success" ]]; then
          echo "### ‚úÖ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ —Ç–µ—Å—Ç—ã: –£—Å–ø–µ—à–Ω–æ" >> final-report.md
        elif [[ "${{ needs.multilingual-tests.result }}" == "skipped" ]]; then
          echo "### ‚ö†Ô∏è –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ —Ç–µ—Å—Ç—ã: –ü—Ä–æ–ø—É—â–µ–Ω—ã" >> final-report.md
        else
          echo "### ‚ö†Ô∏è –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ —Ç–µ—Å—Ç—ã: –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã" >> final-report.md
        fi
        
        echo "" >> final-report.md
        echo "## –°—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏: ${{ job.status }}" >> final-report.md
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ workflow
        echo "## –°—Å—ã–ª–∫–∞ –Ω–∞ workflow:" >> final-report.md
        echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> final-report.md
    
    - name: Upload final report
      uses: actions/upload-artifact@v4
      with:
        name: final-ci-cd-report
        path: final-report.md
    
    - name: Success notification
      if: success()
      run: |
        echo "‚úÖ CI/CD pipeline —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!"
        echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"
        echo "‚úÖ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!"
        echo ""
        echo "–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Å–¥–∞—á–µ!"